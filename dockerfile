# ─────────────────────────────────────────────────────────────
# 1) Base image
# ─────────────────────────────────────────────────────────────
FROM oven/bun:latest

# ─────────────────────────────────────────────────────────────
# 2) Set working dir
# ─────────────────────────────────────────────────────────────
WORKDIR /app

# ─────────────────────────────────────────────────────────────
# 3) Create env
# ─────────────────────────────────────────────────────────────
# ARG UPSTASH_REDIS_URL
# ENV UPSTASH_REDIS_URL=${UPSTASH_REDIS_URL}

# ─────────────────────────────────────────────────────────────
# 4) Install production deps
# ─────────────────────────────────────────────────────────────
COPY package.json bun.lock ./
RUN bun install --production

# ─────────────────────────────────────────────────────────────
# 5) Copy your source
# ─────────────────────────────────────────────────────────────
COPY src/server ./src/server
COPY src/shared ./src/shared

# ─────────────────────────────────────────────────────────────
# 6) Open your HTTP port—and 6379 for the redis client
# ─────────────────────────────────────────────────────────────
EXPOSE 3000 6379

# ─────────────────────────────────────────────────────────────
# 7) build the server
# ─────────────────────────────────────────────────────────────
RUN bun run build:backend

# ─────────────────────────────────────────────────────────────
# 8) run the server
# ─────────────────────────────────────────────────────────────
CMD ["node", "./dist/index.js"]
